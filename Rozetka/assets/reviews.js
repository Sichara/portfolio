var ElementSelect_class=new Class({Class:'ElementSelect_class',options:{selectors:{block:'[name=select_block]',link:'[name=drop_link]',drop_block:'[name=drop_block]',drop_element:'[name=drop_element]',input:'input[type=hidden]'},cssClasses:{hidden:'hidden',checked:'active'},properties:{question:{title:'data-question-title',value:'data-question-value'},value:'data-value',active:'data-active'},entity:'ElementSelectEntity_class',phrases:'Выберите вариант'},_elements:[],initialize:function(){this.attachToObserver(['LoadTabContent','ResetForm'])},init:function(container){var constructor=App.getConstructorByClassName(this.options.entity);constructor&&container.getElements(this.options.selectors.block).each(function(block){this._elements.push(new constructor(block,this).setOptions(this.options).init())}.bind(this));return this},_reset:function(container){container.getElements(this.options.selectors.block).each(function(block){this._elements.forEach(function(element){element._container==block&&element.reset()})}.bind(this))},closeOtherSelect:function(select){this._elements.each(function(element){if(element!=select){element.close()}})},onLoadTabContent:function(data){this.init(data[0])},onResetForm:function(data){this._reset(data[0])}});ElementSelect_class.implement(new Options(),new Events());var ElementSelectEntity_class=new Class({Class:'ElementSelectEntity',options:{selectors:{block:'[name=select_block]',link:'[name=drop_link]',drop_block:'[name=drop_block]',drop_element:'[name=drop_element]',input:'input[type=hidden]'},cssClasses:{hidden:'hidden',checked:'active'},properties:{question:{title:'data-question-title',value:'data-question-value'},value:'data-value',active:'data-active'},phrases:'Выберите вариант'},_container:null,_controller:null,_drop_block:null,_link:null,_input:null,_drop_elements:[],elements:[],initialize:function(container,controller){this._container=container;this._controller=controller},init:function(){this._link=this._container.getElement(this.options.selectors.link);this._drop_block=this._container.getElement(this.options.selectors.drop_block);this._input=this._container.getElement(this.options.selectors.input);this._link.addEvent('click',this._handlerLink.bind(this));this._drop_elements=this._container.getElements(this.options.selectors.drop_element);this._drop_elements.forEach(function(element){if(!~this.elements.indexOf(element)){element.addEvent('click',this._handlerDropElement.bind(this));this.elements.push(element)}}.bind(this));$(document.body).addEvent('click',this._hideDropBlock.bind(this));return this},_handlerDropElement:function(e){var target=e.target,value=target.getProperty(this.options.properties.value);new Event(e).stop();if(value){this._link.setHTML(target.innerHTML);this._input.value=value;this._input.disabled=false;this._clearDropElementsCss();target.addClass(this.options.cssClasses.checked);this.analytic(target);this._fireDropElementEvent(target)}this.close()},_clearDropElementsCss:function(){this._drop_elements.each(function(element){element.hasClass(this.options.cssClasses.checked)&&element.removeClass(this.options.cssClasses.checked)}.bind(this))},_fireEventByName:function(event_name){var event={type:event_name};event['target']=this._input;this._input.fireEvent('focus',event)},_hideDropBlock:function(e){this.close()},close:function(){this.isVisible()&&this._drop_block.addClass(this.options.cssClasses.hidden)},_handlerLink:function(e){new Event(e).stop();this._controller&&this._controller.closeOtherSelect(this);if(this.isVisible()){this._drop_block.addClass(this.options.cssClasses.hidden)}else{this._drop_block.removeClass(this.options.cssClasses.hidden)}this._fireEventByName('focus')},reset:function(){this._link.setHTML(this.options.phrases);if(!this._input.disabled){this._input.value=null;this._input.disabled=true}this._clearDropElementsCss()},isVisible:function(){return!this._drop_block.hasClass('hidden')},_fireDropElementEvent:function(target){document.fireEvent('dropSelectElement',{target:target})},analytic:function(element){var events=[];if(element&&element.hasAttribute(this.options.properties.question.title)&&element.hasAttribute(this.options.properties.question.value)){events.push({name:'eventContext',value:element.getAttribute(this.options.properties.question.title)});events.push({name:'eventContent',value:element.getAttribute(this.options.properties.question.value)})}document.fireEvent('dropDownList',{extend_event:events})}});ElementSelectEntity_class.implement(new Options(),new Events());var ElementSelectSortEntity_class=ElementSelectEntity_class.extend({Class:'ElementSelectSortEntity_class',init:function(){this.parent();this._drop_block.addEvent('click',function(event){new Event(event).stop()});return this},_handlerDropElement:function(e){this.parent(e);window.location.href=e.target.href;this.fireEvent('sortEntityChanged')},setActiveElemByValue:function(value){var elem=null;this._drop_elements.each(function(el){if(el.getProperty(this.options.properties.value)==value){elem=el}}.bind(this));if(elem){this._link.setHTML(elem.innerHTML);this._input.value=value;this._input.disabled=false;this._clearDropElementsCss();elem.addClass(this.options.cssClasses.checked)}}});var RozetkaUserReviewsController_class=new Class({options:{item_controller_class:'RozetkaCommentItemController_class',item_controller_options:null},_items:{},_is_ajax_in_process:false,_requests_queue:[],_comments_count:0,registerComments:function(comment_elements){comment_elements.each(function(item){var comment_id=item.getAttribute('data-comment-id');if(!this._items[comment_id]){++this._comments_count;this._items[comment_id]=new window[this.options.item_controller_class](item,this,this._comments_count);if(this.options.item_controller_options){this._items[comment_id].setOptions(this.options.item_controller_options)}if(item.hasClass('opened')){this._items[comment_id].showFullComment()}}},this)},sendRequest:function(request){this._requests_queue.push(request);if(!this._is_ajax_in_process){this._sendNextRequest()}},_sendNextRequest:function(){if(this._requests_queue.length){this._is_ajax_in_process=true;var request=this._requests_queue.shift();new Ajax('/cgi-bin/form.php',{method:'post',headers:{ajaxAction:request.action},data:request.data,onSuccess:this._sendNextRequest.bind(this),onFailure:this._sendNextRequest.bind(this)}).request()}else{this._is_ajax_in_process=false}}});RozetkaUserReviewsController_class.implement(new Options());var RozetkaCommentItemController_class=new Class({options:{selectors:{short_comment:'[name=comment-content-short]',full_comment:'[name=comment-content-full]',star:'[name=star] img',show_full_comment:'[name=comment-content-short]',hide_full_comment:'[name=hide-full-comment]',answers_count:'[name=answers_count]',answer_selector:'[name=answer]',answer_link:'[name=answer]'},class_names:{star_active:'rated',favorite_comment:'js-favorite',this_user_comment:'js-this-user-comment',unreaded:'new',answers_count_unreaded:'new',answers_count_readed:''}},_comment_elements_container:null,_short_comment:null,_full_comment:null,_star:null,_show_full_comment:[],_hide_full_comment:[],_answers_count_elem:null,_answer_link_elem:null,_is_favorite:null,_ajax_obj:null,_reviews_controller:null,initialize:function(comment_elem,reviews_controller,order){this._reviews_controller=reviews_controller;this._comment_elements_container=comment_elem;this._answer_link_elem=comment_elem.getElements(this.options.selectors.answer_link)[0];this._answers_count_elem=comment_elem.getElements(this.options.selectors.answers_count)[0];this._short_comment=comment_elem.getElements(this.options.selectors.short_comment)[0];this._full_comment=comment_elem.getElements(this.options.selectors.full_comment)[0];this._star=comment_elem.getElements(this.options.selectors.star)[0];this._show_full_comment=comment_elem.getElements(this.options.selectors.show_full_comment);this._hide_full_comment=comment_elem.getElements(this.options.selectors.hide_full_comment);this._order=order;this._initElements();this._bindEvents();this._bindGTMEvents()},_initElements:function(){if(!this.isReaded()&&this._answers_count_elem){this._answers_count_elem.addClass(this.options.class_names.answers_count_unreaded)}this._setFavorite(this.isCommentFavorite(),false)},_bindEvents:function(){this._show_full_comment.addEvent('click',this._showFullComment.bind(this));this._hide_full_comment.addEvent('click',this._hideFullComment.bind(this));this._star.addEvent('click',this._toggleRated.bind(this))},_bindGTMEvents:function(){var product_href=this._comment_elements_container.getElements('.gtm-product-href');if(product_href.length){product_href.addEvent('click',function(){document.fireEvent('openProductPage',[{extend_event:[{name:'eventValue',value:this._comment_elements_container.getAttribute('data-price')},{name:'eventProductId',value:this._comment_elements_container.getAttribute('data-product-id')},{name:'eventProductVendorId',value:this._comment_elements_container.getAttribute('data-vendor-id')},{name:'eventProductCategoryId',value:this._comment_elements_container.getAttribute('data-category-id')},{name:'eventProductCategoryGroupId',value:this._comment_elements_container.getAttribute('data-top-category-id')}]}])}.bind(this))}this._answer_link_elem.addEvent('click',function(){document.fireEvent('answer_comment',[{extend_event:[{name:'eventProductId',value:this._comment_elements_container.getAttribute('data-product-id')},{name:'eventPosition',value:this._order}]}])}.bind(this))},isReaded:function(){var result=false;if(this._getLastAnswer()&&this._comment_elements_container.getAttribute('data-is-answers-readed')=='1'){result=true}return result},setReaded:function(){if(!this.isReaded()&&this._getLastAnswer()){this._comment_elements_container.setAttribute('data-is-answers-readed',1);if(this._answers_count_elem){this._answers_count_elem.removeClass(this.options.class_names.answers_count_unreaded);this._answers_count_elem.addClass(this.options.class_names.answers_count_readed);if(this._comment_elements_container.getAttribute('data-answers-count')){this._answers_count_elem.setText(this._comment_elements_container.getAttribute('data-answers-count'))}}this._comment_elements_container.removeClass(this.options.class_names.unreaded);new Ajax('/cgi-bin/form.php',{method:'post',headers:{ajaxAction:'https://my.rozetka.com.ua/profile/reviews/#setReadedComment'},data:{id:this._comment_elements_container.getAttribute('data-comment-id')}}).request()}},isCommentFavorite:function(){if(this._is_favorite==null){this._is_favorite=this._comment_elements_container.hasClass(this.options.class_names.favorite_comment)||this._comment_elements_container.getElementsBySelector('.'+this.options.class_names.favorite_comment).length}return this._is_favorite},_getLastAnswer:function(){var answers=this._comment_elements_container.getElementsBySelector(this.options.selectors.answer_selector),result=null;if(answers.length){result=answers[answers.length-1]}return result},_setFavorite:function(flag,send_request){this._is_favorite=flag;if(flag){this._star.addClass(this.options.class_names.star_active)}else{this._star.removeClass(this.options.class_names.star_active)}if(send_request){this._reviews_controller.sendRequest({action:'https://my.rozetka.com.ua/profile/reviews/#setFavorite',data:{id:this._comment_elements_container.getAttribute('data-comment-id'),favorite_for_author:this.isCommentFavorite()?1:0}})}},_toggleRated:function(e){new Event(e).stop();document.fireEvent('change_favourite_comment',[{extend_event:[{name:'eventContent',value:!this._is_favorite?'set':'remove'}]}]);this._setFavorite(!this._is_favorite,true)},_showFullComment:function(e){new Event(e).stop();this.showFullComment()},showFullComment:function(){document.fireEvent('toggle_comment',[{extend_event:[{name:'eventContent',value:'show'},{name:'eventContext',value:this.isReaded()?'read':'unread'},{name:'eventPosition',value:this._order}]}]);this._short_comment.addClass('hidden');this._full_comment.removeClass('hidden');this._comment_elements_container.addClass('opened');this._comment_elements_container.removeClass('closed');this.setReaded()},_hideFullComment:function(e){new Event(e).stop();document.fireEvent('change_favourite_comment',[{extend_event:[{name:'eventContent',value:'hide'},{name:'eventContext',value:this.isReaded()?'read':'unread'},{name:'eventPosition',value:this._order}]}]);this._comment_elements_container.removeClass('opened');this._comment_elements_container.addClass('closed');this._full_comment.addClass('hidden');this._short_comment.removeClass('hidden')}});RozetkaCommentItemController_class.implement(new Options());var GTMData_MyReviews_class=GTMData_BaseAbstract_class.extend({options:{GTM:{events:{open_product_page:{event_name:'openProductPage',extend_event:[{name:'eventCategory',value:'Interactions'},{name:'eventAction',value:'click'},{name:'eventContext',value:'title'},{name:'eventLabel',value:'openProductPage'}]},change_favourite_comment:{event_name:'change_favourite_comment',extend_event:[{name:'eventCategory',value:'Interactions'},{name:'eventAction',value:'click'},{name:'eventLabel',value:'favouriteComment'}]},toggle_comment:{event_name:'toggle_comment',extend_event:[{name:'eventCategory',value:'Interactions'},{name:'eventAction',value:'click'},{name:'eventLabel',value:'comment'}]},answer_comment:{event_name:'answer_comment',extend_event:[{name:'eventCategory',value:'Interactions'},{name:'eventAction',value:'click'},{name:'eventLabel',value:'answerComment'}]},page_number:{event_name:'pageNumberClick',extend_event:[{name:'eventCategory',value:'Interactions'},{name:'eventAction',value:'click'},{name:'eventLabel',value:'pageNumber'}]},show_more:{event_name:'clickMoreButton',extend_event:[{name:'eventCategory',value:'Interactions'},{name:'eventAction',value:'click'},{name:'eventLabel',value:'morePages'}]}}}},base_GTM_event:{eventLocation:'myComments'}});App.addOnDomReady(function(){new ElementSelect_class().setOptions({entity:'ElementSelectSortEntity_class'}).init(document.body)});